<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">


<!-- Mirrored from www.opentk.com/doc/chapter/2/opengl/fragment-ops/occlusion-query by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 10 May 2016 13:48:33 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="prev" href="depth-test.html" />

<link rel="up" href="../fragment-ops.html" />

<link rel="next" href="conditional-render.html" />

<link rel="shortcut icon" href="http://www.opentk.com/sites/all/favicon.ico" type="image/x-icon" />
    <title>06. Occlusion Query | OpenTK</title>
    <!--[if !lt IE 7]> <style type="text/css" media="all">@import "/files/css/0d190fbd13bda50135e2c474ba9cb190.css";</style>
 <![endif]-->
    <!--[if !IE]>--> <style type="text/css" media="all">@import "http://www.opentk.com/files/css/0d190fbd13bda50135e2c474ba9cb190.css";</style>
 <!--<![endif]-->
    <!--[if IE 7]><style type="text/css" media="all">@import "/sites/all/themes/community4/IE67.css";</style><![endif]-->
    </head>

<body class="not-front not-logged-in ntype-book main-sidebar">

    <div id="layer1">
    
        <div id="header-bg">

            <div id="header">
           
                                    <a href="../../../../../index.html"><img src="http://www.opentk.com/sites/all/themes/community3/images/community2_logo.jpg" alt="Home" id="logo" /></a>
                                
                <div id="bg-image"><img src="http://www.opentk.com/sites/all/themes/community2/images/bg-header2.png" width="100%" height="100%" /></div>

                
                                    <h2 class='siteSlogan'>Home of the Open Toolkit library</h2>
                
                
                                  <div class="primary-links-wrapper">
                    <ul class="primary-links" id="navtabs"><li  class="first menu-1-1-2"><a href="../../../../../index.html" title="Return to the OpenTK homepage." class="menu-1-1-2">Home</a></li>
<li  class="menu-1-2-2"><a href="http://www.opentk.com/project/opentk" title="Learn more or download OpenTK." class="menu-1-2-2">Project</a></li>
<li  class="menu-1-3-2"><a href="../../../../../doc.html" title="Read the OpenTK programming guide." class="menu-1-3-2">Documentation</a></li>
<li  class="menu-1-4-2"><a href="http://www.opentk.com/forum/2" title="Discuss OpenTK or ask for help." class="menu-1-4-2">Forum</a></li>
<li  class="menu-1-5-2"><a href="http://www.opentk.com/files/opentk-issues.html" title="View issue reports for OpenTK." class="menu-1-5-2">Issues</a></li>
<li  class="menu-1-6-2"><a href="http://www.opentk.com/blog" title="Read the blogs of OpenTK users." class="menu-1-6-2">Blogs</a></li>
<li  class="menu-1-7-2"><a href="http://www.opentk.com/project/all" title="Search the database of OpenTK projects." class="menu-1-7-2">Gallery</a></li>
<li  class="last menu-1-8-2"><a href="http://www.opentk.com/search" title="Quickly locate content on the site." class="menu-1-8-2">Search</a></li>
</ul>                  </div>
                
            </div>
            
        </div>

        <div id="page" class="clear-block">
            <div id="wrapper" class="clear-block">
                <div id="subwrapper">
                    <div id="container">
                        <div id="content">

                            
                            <div class="content-area">

                                                                    
                                <div class="tabs clear-block">
                                    <div class="breadcrumb"><a href="../../../../../index.html">Home</a> » <a href="../../../../../doc.html" title="What is this all about?">Introduction</a> » <a href="../../../../graphics.html" title="Description of the OpenTK.Graphics namespace, plus a quick OpenGL and OpenGL|ES primer.">Graphics</a> » <a href="../fragment-ops.html">Fragment Operations</a></div>                                </div>
                                
                                
                                
                                <div class="node-content-wrapper">

                                    				<div id="node-767" class="node ntype-book clear-block">

	
			<h1 class="title"><a href="occlusion-query.html">06. Occlusion Query</a></h1>    
	
	

    <div class="content">
	    
        <p>Occlusion queries count the number of fragments (or samples) that pass the depth test, which is useful to determine visibility of objects.</p>
<p>If an object is drawn but 0 fragments passed the depth test, it is fully occluded by another object. In practice this means that a simplification of an object is drawn using an occlusion query (for example: A bounding box can be the occlusion substitute for a truck) and only if fragments of the simple object pass the depth test, the complex object is drawn. Please read <a href="http://www.opentk.com/node/778">Conditional Render</a> for a convenient solution.</p>
<p>Note that the simplified object does not actually have to become visible, one can set GL.ColorMask and GL.DepthMask to false for the purpose of the occlusion query. The only GL.Enable/Disable state associated with it is the <a href="http://www.opentk.com/node/766">DepthTest</a>. If DepthTest is disabled all fragments will automatically pass it and the occlusion test becomes pointless.</p>
<p>Occlusion Query handles are generated and deleted similar to other OpenGL handles:</p>
<div class="geshifilter">
<pre class="geshifilter-csharp"><span class="kw1">uint</span> MyOcclusionQuery;
<span class="kw3">GL</span>.<span class="me1">GenQueries</span><span class="br0">&#40;</span> <span class="nu0">1</span>, <span class="kw1">out</span> MyOcculsionQuery <span class="br0">&#41;</span>;
<span class="kw3">GL</span>.<span class="me1">DeleteQueries</span><span class="br0">&#40;</span> <span class="nu0">1</span>, <span class="kw1">ref</span> MyOcculsionQuery <span class="br0">&#41;</span>;</pre></div>
<p>The draw commands which contribute to the count must be enclosed with GL.BeginQuery() and GL.EndQuery().</p>
<div class="geshifilter">
<pre class="geshifilter-csharp"><span class="kw3">GL</span>.<span class="me1">BeginQuery</span><span class="br0">&#40;</span> QueryTarget.<span class="me1">SamplesPassed</span>, MyOcculsionQuery <span class="br0">&#41;</span>;
<span class="co1">// draw...</span>
<span class="kw3">GL</span>.<span class="me1">EndQuery</span><span class="br0">&#40;</span> QueryTarget.<span class="me1">SamplesPassed</span> <span class="br0">&#41;</span>;</pre></div>
<p>It is very important to understand that this process is running asynchronous, by the time the CPU is querying the result of the count the GPU might not be done counting yet. OpenGL provides additional query commands to determine whether the occlusion query result is available, but before it is confirmed to be available any query of the count is not reliable. The following code will get a reliable result.</p>
<div class="geshifilter">
<pre class="geshifilter-csharp"><span class="kw1">uint</span> ResultReady=<span class="nu0">0</span>;
<span class="kw1">while</span> <span class="br0">&#40;</span> ResultReady == <span class="nu0">0</span> <span class="br0">&#41;</span>
<span class="br0">&#123;</span>
  <span class="kw3">GL</span>.<span class="me1">GetQueryObject</span><span class="br0">&#40;</span> MyOcculsionQuery, GetQueryObjectParam.<span class="me1">QueryResultAvailable</span>, <span class="kw1">out</span> ResultReady <span class="br0">&#41;</span>;
<span class="br0">&#125;</span>
<span class="kw1">uint</span> MyOcclusionQueryResult=<span class="nu0">0</span>;
<span class="kw3">GL</span>.<span class="me1">GetQueryObject</span><span class="br0">&#40;</span> MyOcculsionQuery, GetQueryObjectParam.<span class="me1">QueryResult</span>, <span class="kw1">out</span> MyOcclusionQueryResult <span class="br0">&#41;</span>;
<span class="co1">// MyOcclusionQueryResult is now reliable.</span></pre></div>
<p>However this is not very efficient to use because the CPU will spin in a loop until the GPU is done counting.</p>
<p>A better approach is to do the occlusion queries in the first frame and do not wait for a result. Instead continue drawing as normal and wait for the next frame, before you check the results of the query. In other words frame n executes the query and frame n + 1 reads back the results. </p>
<p>This approach hides the latency inherent in occlusion queries and improves performance, at the cost of slight visual glitches (an object may become visible one frame later than it should). You can read a very detailed description of this technique on <a href="http://http.developer.nvidia.com/GPUGems/gpugems_ch29.html">Chapter 29 of GPU Gems 1</a>, which also covers other caveats of occlusion queries.</p>
<div class="book-navigation"><ul class="menu"><li class="leaf"><a href="conditional-render.html">Conditional Render</a></li></ul><div class="page-links clear-block"><a href="depth-test.html" class="page-previous" title="Go to previous page">‹ 05. Depth Test</a><a href="../fragment-ops.html" class="page-up" title="Go to parent page">up</a><a href="conditional-render.html" class="page-next" title="Go to next page">Conditional Render ›</a></div></div>
        <div class="clear-block"></div>
        
                    <div class="links">
                <ul class="links inline"><li  class="first book_printer"><a href="http://www.opentk.com/book/export/html/767" title="Show a printer-friendly version of this book page and its sub-pages." class="book_printer">Printer-friendly version</a></li>
<li  class="last comment_forbidden"><span class="comment_forbidden"><a href="http://www.opentk.com/user/login?destination=node/767%2523comment-form">Login</a> or <a href="http://www.opentk.com/user/register?destination=node/767%2523comment-form">register</a> to post comments</span></li>
</ul>            </div>
            <br />
        
		
    </div> <!-- content -->

</div> <!-- /#node-767 -->

<div id="comments">
  
</div>
                                    
                                </div>
                            </div>
                        </div>
                    </div>

                                            <div id="main_supplements">
                        
                            <div class="block-wrapper">

	<div id="block-block-1" class="block block-block">
				<div class="content">
					<div>
		<form action="http://www.opentk.com/user?destination=node%2F767" method="post" id="user-login-form">
			<div class="form-item">
				<input type="text" value="Username" style="color: #777;" maxlength="60" name="name" id="edit-name" size="15" class="form-text required" onfocus="this.select()" />
			</div>
			<div class="form-item">
				<input type="password" value="Password" style="color: #777;" name="pass" id="edit-pass" size="15" class="form-text required" onfocus="this.select()" />
			</div>
                        <div class="form-item"><input type="submit" name="op" id="edit-submit" value="Log in" /></div>
			<div class="item-list">
				<ul>
					<li><a href="http://www.opentk.com/user/register" title="Create account">Create account</a></li>
					<li><a href="http://www.opentk.com/user/password" title="Reset password">Reset password</a></li>
				</ul>
				<input type="hidden" name="form_id" id="edit-user-login" value="user_login" />
			</div>
		</form>
	</div>
		</div>
	</div>

</div>

<div class="block-wrapper">

	<div id="block-blockcache-26" class="block block-blockcache">
					<h4 class="block-title">Commit log</h4>				<div class="content">
			<div class="item-list"><ul><li><a href="https://github.com/opentk/opentk/commit/2e51fe019771f4c70b15bb25b3a560f712a45fbf">Notice of leave</a>
</li><li><a href="https://github.com/opentk/opentk/commit/6ac1c63ff3a35367f78b500e06b2d3ca5bff3a69">Merge pull request #328 from WardBenjamin/develop</a>
</li><li><a href="https://github.com/opentk/opentk/commit/55bd3424179168eb886a853ba16633f65808320a">Fix documentation for NativeWindow.WindowBorder</a>
</li></ul></div><div class="more-link"><a href="http://www.opentk.com/aggregator/sources/1" title="View this feed&#039;s recent news.">more</a></div>		</div>
	</div>

</div>

                            
                        </div>
                                    </div>
		
            </div>
	    
	    
	</div>
	
    </div> <!-- #layer1 -->


    
        <div id="footer">

            
                            <div id="footer-layer">

<p><small>Site design by Stefanos A. Icons courtesy of <a href="http://www.gnome-look.org/content/show.php/GNOME-colors?content=82562">gnome-colors</a>.</small></p>

</div>
                    </div>

        
    
</body>


<!-- Mirrored from www.opentk.com/doc/chapter/2/opengl/fragment-ops/occlusion-query by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 10 May 2016 13:48:33 GMT -->
</html>
